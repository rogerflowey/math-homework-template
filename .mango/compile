#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd "$script_dir/.." && pwd)"
user_root="${MANGO_USER_PATH:-$repo_root}"

# Check if xelatex is available
if ! command -v xelatex &> /dev/null; then
    echo "Error: xelatex is not installed. Please install TeX Live."
    exit 1
fi

# Compile LaTeX file
if [ $# -eq 0 ]; then
    echo "Usage: mango compile <filename.tex>"
    exit 1
fi

filename="$1"

if [[ "$filename" = /* ]]; then
    tex_path="$filename"
else
    tex_path=""
    for base in "$user_root" "$repo_root"; do
        candidate="$base/$filename"
        if [[ -f "$candidate" ]]; then
            tex_path="$candidate"
            break
        fi
    done
fi

if [[ -z "${tex_path:-}" ]]; then
    echo "Error: could not find $filename relative to $user_root or $repo_root" >&2
    exit 1
fi

output_dir="$(dirname "$tex_path")"
xelatex -interaction=nonstopmode -output-directory="$output_dir" "$tex_path"